#' Generate offspring for a healthcare-worker (HCW) parent with work-place and post-admission thinning
#'
#' Simulates secondary infections (offspring) generated by a **healthcare-worker** parent.
#' The number of candidate offspring is drawn from a Negative Binomial distribution.
#' Candidate infection times are drawn from a **truncated Gamma** generation-time distribution
#' on \eqn{[0, t_\mathrm{outcome}]}. For HCW parents, **pre-admission** candidate infections
#' may occur in the **hospital** (while working) or in the **community**: each pre-admission
#' event is assigned to the hospital with probability \code{prob_hospital_cond_hcw_preAdm}
#' and to the community otherwise. Candidate events occurring at or after the parentâ€™s
#' hospitalisation time are always labelled \code{"hospital"}. Hospital-setting events are then
#' thinned to reflect protection before admission (PPE/IPC) and quarantine after admission:
#' pre-admission hospital keeps with probability \eqn{1 - \mathrm{ppe\_efficacy\_hcw}}; post-admission
#' hospital keeps with probability \eqn{1 - \mathrm{hospital\_quarantine\_efficacy}}. Finally, each
#' offspring is assigned a class (\code{"HCW"} or \code{"genPop"}) using setting-specific probabilities.
#'
#' @param parent_hospitalised Logical scalar. Whether the parent (HCW infector) is hospitalised.
#' @param parent_time_to_hospitalisation Numeric scalar \eqn{\ge 0} or \code{NA}. If hospitalised,
#'   the time from infection to hospital admission; must be non-negative. If not hospitalised,
#'   must be \code{NA}.
#' @param parent_time_to_outcome Numeric scalar \eqn{\ge 0}. Time from infection to outcome
#'   (recovery/death); used to truncate the generation-time distribution.
#'
#' @param mn_offspring_hcw Positive numeric. Mean of the Negative Binomial offspring distribution
#'   for HCW parents (\code{rnbinom(mu = ..., size = ...)}).
#' @param overdisp_offspring_hcw Positive numeric. Negative Binomial \code{size} (overdispersion)
#'   for HCW parents.
#'
#' @param Tg_shape_hcw Positive numeric. Shape of the Gamma generation-time distribution
#'   for HCW parents (before truncation).
#' @param Tg_rate_hcw Positive numeric. Rate of the Gamma generation-time distribution
#'   for HCW parents (before truncation). Mean GT is \code{Tg_shape_hcw / Tg_rate_hcw}.
#'
#' @param prob_hospital_cond_hcw_preAdm Numeric in \code{[0,1]}. Probability that a **pre-admission**
#'   candidate infection occurs in the **hospital** setting (while the HCW is working); the
#'   complementary probability assigns the event to the community.
#' @param ppe_efficacy_hcw Numeric in \code{[0,1]}. Efficacy of PPE/IPC at reducing **pre-admission
#'   hospital** transmission; pre-admission hospital keep-probability equals
#'   \code{1 - ppe_efficacy_hcw}.
#' @param hospital_quarantine_efficacy Numeric in \code{[0,1]}. Efficacy of **post-admission
#'   hospital** quarantine at reducing transmission; post-admission hospital keep-probability equals
#'   \code{1 - hospital_quarantine_efficacy}.
#'
#' @param prob_hcw_cond_hcw_comm Numeric in \code{[0,1]}. Probability that a **community**-located
#'   offspring generated by an HCW parent is an HCW.
#' @param prob_hcw_cond_hcw_hospital Numeric in \code{[0,1]}. Probability that a **hospital**-located
#'   offspring generated by an HCW parent is an HCW.
#' @export
offspring_function_hcw <- function(

  ## Characteristics and properties of the parent (who we are generating the offspring for)
  parent_info,

  ## Parameters of the offspring and generation time distributions for HCWs
  mn_offspring_hcw = NULL,                  # mean of the offspring distribution for HCWs
  overdisp_offspring_hcw = NULL,            # overdispersion of the offspring distribution for HCWs
  Tg_shape_hcw = NULL,                      # gamma shape parameter for Tg distribution for HCWs
  Tg_rate_hcw = NULL,                       # gamma rate parameter for Tg distribution for HCWs

  ## Setting model for HCWs
  prob_hospital_cond_hcw_preAdm = NULL,     # probability that an infection generated prior to parent hospitaliation occurs in the hospital (whilst HCW is working)
  ppe_efficacy_hcw = NULL,                  # efficacy of PPE/IPC measures at reducing transmission (i.e. pre hospitalisation)
  hospital_quarantine_efficacy = NULL,      # efficacy of quarantine at reducing transmission (i.e. post hospitalisation)

  ## Probabilities for HCW infecting either genPop or HCWs, depending on the setting
  prob_hcw_cond_hcw_comm = NULL,            # prob that a community-located infection generated by HCW is a HCW
  prob_hcw_cond_hcw_hospital = NULL         # prob that a hospital-located infection generated by HCW is a HCW
) {

  #########################################################################################
  ## Checks to make sure function inputs are correctly specified
  #########################################################################################
  if (is.null(parent_hospitalised) || length(parent_hospitalised) != 1L || !is.logical(parent_hospitalised) || is.na(parent_hospitalised)) {
    stop("`parent_hospitalised` must be a single logical value: TRUE or FALSE.", call. = FALSE)
  }
  if (isTRUE(parent_hospitalised)) {
    if (is.null(parent_time_to_hospitalisation) || length(parent_time_to_hospitalisation) != 1L ||
        !is.numeric(parent_time_to_hospitalisation) || is.na(parent_time_to_hospitalisation) || parent_time_to_hospitalisation < 0) {
      stop("When `parent_hospitalised` is TRUE, `parent_time_to_hospitalisation` must be a single non-negative numeric value (not NA).", call. = FALSE)
    }
  }
  if (is.null(parent_time_to_outcome) || length(parent_time_to_outcome) != 1L ||
      !is.numeric(parent_time_to_outcome) || is.na(parent_time_to_outcome) || parent_time_to_outcome < 0) {
    stop("`parent_time_to_outcome` must be a single non-negative numeric value (not NA).", call. = FALSE)
  }
  if (identical(parent_hospitalised, FALSE)) {
    if (!is.na(parent_time_to_hospitalisation)) {
      stop("When `parent_hospitalised` is FALSE, `parent_time_to_hospitalisation` must be NA.", call. = FALSE)
    }
  }
  ## Parameter checks (positivity / bounds)
  for (nm in c("mn_offspring_hcw","overdisp_offspring_hcw","Tg_shape_hcw","Tg_rate_hcw")) {
    val <- get(nm, inherits = FALSE)
    if (is.null(val) || length(val) != 1L || !is.numeric(val) || is.na(val) || val <= 0)
      stop(sprintf("`%s` must be a single positive numeric value.", nm), call. = FALSE)
  }
  for (nm in c("prob_hospital_cond_hcw_preAdm","ppe_efficacy_hcw","hospital_quarantine_efficacy",
               "prob_hcw_cond_hcw_comm","prob_hcw_cond_hcw_hospital")) {
    val <- get(nm, inherits = FALSE)
    if (is.null(val) || length(val) != 1L || !is.numeric(val) || is.na(val) || val < 0 || val > 1)
      stop(sprintf("`%s` must be a single numeric value in [0, 1].", nm), call. = FALSE)
  }

  ########################################################################################################
  ## Generating offspring, offspring infection times, offspring infection locations & offspring classes
  ########################################################################################################

  # Step 0: Extract relevant parent information from parent_info
  parent_hospitalised = parent_info$hospitalisation                          # whether the parent (infector) is hospitalised or not
  parent_time_to_hospitalisation = parent_info$time_hospitalisation_relative # if parent is hospitalised, the time of hospitalisation (relative to infection)
  parent_time_to_outcome = parent_info$time_outcome_relative                 # the time when the parent dies/recovers (relative to time of infection)

  # Step 1: Draw from offspring distribution to produce raw number of offspring
  num_offspring_raw <- rnbinom(n = 1, mu = mn_offspring_hcw, size = overdisp_offspring_hcw)

  # Step 2: Generate time of infection for each offspring based on the generation time (truncated at outcome)
  infection_times <- rtrunc_gamma(n = num_offspring_raw, lower = 0, upper = parent_time_to_outcome, Tg_shape = Tg_shape_hcw, Tg_rate = Tg_rate_hcw)

  # Step 3: Generate location of infection, noting that for HCWs, pre-hospitalisation infections can be community *or* hospital (while working). This is
  #         controlled via prob_hospital_cond_hcw_preAdm. Post-hospitalisation events are necessarily hospital.
  t_hosp <- if (isTRUE(parent_hospitalised)) parent_time_to_hospitalisation else Inf
  if (is.finite(t_hosp) && parent_time_to_outcome <= t_hosp) t_hosp <- Inf
  pre_admission <- infection_times < t_hosp
  is_hosp_pre_admission <- as.logical(rbinom(n = length(infection_times), size = 1, prob = prob_hospital_cond_hcw_preAdm))
  infection_settings <- ifelse(pre_admission, ifelse(is_hosp_pre_admission, "hospital", "community"), "hospital")

  # Step 4: Thin / remove some hospital infections due to PPE (pre-hospitalisation) or quarantine (post-hospitalisation)
  p_keep_infection <- ifelse(infection_settings == "community", 1, ifelse(pre_admission, 1 - ppe_efficacy_hcw, 1 - hospital_quarantine_efficacy))
  keep_infection <- as.logical(rbinom(n = length(infection_times), size = 1, prob = p_keep_infection))
  infection_times <- infection_times[keep_infection]
  infection_settings <- infection_settings[keep_infection]
  num_offspring_quarantine <- length(infection_times)

  # Step 5: Assign class (HCW or genPop) to each offspring based on setting (HCW parent)
  offspring_class <- rep("genPop", num_offspring_quarantine)
  prob_hcw <- ifelse(infection_settings == "community", prob_hcw_cond_hcw_comm, prob_hcw_cond_hcw_hospital)
  flip_hcw <- as.logical(rbinom(n = num_offspring_quarantine, size = 1, prob = prob_hcw))
  offspring_class[flip_hcw] <- "HCW"

  # Step 6: Define and output dataframe with the results
  offspring_df <- data.frame(infection_location = infection_settings,
                             time_infection_relative = infection_times,
                             class = offspring_class,
                             stringsAsFactors = FALSE)

  return(offspring_df)
}
